import { keyboards } from '../utils/keyboards.js';

// –•—Ä–∞–Ω–∏–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –Ω–∞–∂–∞–ª–∏ "–°—Ç–∞—Ä—Ç"
const startedUsers = new Set();

export function setupStartHandler(bot) {
  bot.start((ctx) => {
    const userId = ctx.from.id;

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ø–µ—Ä–≤—ã–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π "–°—Ç–∞—Ä—Ç"
    if (!startedUsers.has(userId)) {
      ctx.reply(
        `üëã –ü—Ä–∏–≤–µ—Ç, ${ctx.from.first_name}!\n\n` +
        `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ *Forex Quiz Bot* üìä\n\n` +
        `–ó–¥–µ—Å—å —Ç—ã —Å–º–æ–∂–µ—à—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –æ —Ñ–æ—Ä–µ–∫—Å–µ –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è—Ö —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∫–≤–∏–∑!\n\n` +
        `–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É *üöÄ –°—Ç–∞—Ä—Ç*, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å üëá`,
        { parse_mode: 'Markdown', ...keyboards.firstStart() }
      );
    } else {
      // –ï—Å–ª–∏ —É–∂–µ –±—ã–ª ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω–æ–µ –º–µ–Ω—é
      ctx.reply(
        `üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, ${ctx.from.first_name}!\n\n` +
        `–ì–æ—Ç–æ–≤ –ø—Ä–æ–π—Ç–∏ –∫–≤–∏–∑ –µ—â—ë —Ä–∞–∑? üìä`,
        keyboards.main()
      );
    }
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "üöÄ –°—Ç–∞—Ä—Ç"
  bot.hears('üöÄ –°—Ç–∞—Ä—Ç', (ctx) => {
    const userId = ctx.from.id;
    startedUsers.add(userId); // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –°—Ç–∞—Ä—Ç

    ctx.reply(
      `–û—Ç–ª–∏—á–Ω–æ! üéØ\n\n` +
      `–¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏ *üìä –û—Ç–∫—Ä—ã—Ç—å Forex Quiz*, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∫–≤–∏–∑ –ø—Ä—è–º–æ –∑–¥–µ—Å—å –≤ Telegram!\n\n` +
      `–£–¥–∞—á–∏! üöÄ`,
      { parse_mode: 'Markdown', ...keyboards.main() }
    );
  });

  bot.hears('‚ÑπÔ∏è –û –±–æ—Ç–µ', (ctx) => {
    ctx.reply(
      `‚ÑπÔ∏è *Forex Quiz Mini App*\n\n` +
      `–ö–≤–∏–∑ –Ω–∞ –∑–Ω–∞–Ω–∏–µ —Ñ–æ—Ä–µ–∫—Å–∞ –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π.\n\n` +
      `*–°—Ç–µ–∫:* Node.js ¬∑ Telegraf ¬∑ Supabase ¬∑ Telegram Mini App\n\n` +
      `–ù–∞–∂–º–∏ *üìä –û—Ç–∫—Ä—ã—Ç—å Forex Quiz* —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!`,
      { parse_mode: 'Markdown', ...keyboards.main() }
    );
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –º–∏–Ω–∏–∞–ø–ø–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å–Ω–æ–≤–∞
  bot.on('web_app_data', (ctx) => {
    let payload;
    try {
      payload = JSON.parse(ctx.webAppData.data);
    } catch {}

    ctx.reply(
      '‚úÖ –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø—Ä–æ—à–ª–∏ –∫–≤–∏–∑!\n\n–ú–æ–∂–µ—Ç–µ –ø—Ä–æ–π—Ç–∏ –µ—â—ë —Ä–∞–∑ üëá',
      keyboards.main()
    );
  });
}
